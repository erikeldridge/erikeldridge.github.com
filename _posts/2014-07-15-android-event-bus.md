---
layout: note
tags: playground android eventbus
---

# Android event bus

* toc
{:toc}


## Goal

Implement event bus we can publish and subscribe to in Android

Events should be able to carry a payload.

All subscribers should be on the main thread.

Prefer reuse of existing pubsub/eventbus.


## Approach

Reuse Square's [Otto](http://square.github.io/otto/) event bus utility

Create a sample app that registers a listener and publishes an event in onStart, and unregisters the listener in onPause.


## Project structure

    app/src/main/
      java/com/example/app/
        LoadEvent.java
        MainActivity.java
      res/layout/
        activity_main.xml
      AndroidManifest.xml
    build.gradle
    proguard-rules.pro


## LoadEvent.java

An example event with payload

{% highlight java tabsize 2 %}
package com.example.app;

public class LoadEvent {
    final int code;
    public LoadEvent(int code) {
        this.code = code;
    }
}
{% endhighlight %}


## MainActivity.java

A main class demonstrating subscription, publication, payload reference, and unsubscription.

{% highlight java tabsize 2 %}
package com.example.app;

import android.app.Activity;
import android.os.Bundle;
import android.widget.Toast;

import com.squareup.otto.Bus;
import com.squareup.otto.Subscribe;


public class MainActivity extends Activity {
    private Bus mBus = new Bus();

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
    }

    @Subscribe public void answerAvailable(LoadEvent e) {
        Toast.makeText(getApplicationContext(), "loaded, code=" + e.code, Toast.LENGTH_SHORT).show();
    }

    @Override
    protected void onStart() {
        super.onStart();
        mBus.register(this);
        mBus.post(new LoadEvent(1));
    }

    @Override
    protected void onPause() {
        super.onPause();
        mBus.unregister(this);
    }

}
{% endhighlight %}


## activity_main.xml

As generated by Android Studio. Included for completeness

{% highlight xml tabsize 2 %}
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:paddingLeft="@dimen/activity_horizontal_margin"
    android:paddingRight="@dimen/activity_horizontal_margin"
    android:paddingTop="@dimen/activity_vertical_margin"
    android:paddingBottom="@dimen/activity_vertical_margin"
    tools:context=".MainActivity">
    <TextView
        android:text="@string/hello_world"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content" />
</RelativeLayout>
{% endhighlight %}


## AndroidManifest.xml

As generated by Android Studio. Included for completeness

{% highlight xml tabsize 2 %}
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.app" >
    <application
        android:allowBackup="true"
        android:icon="@drawable/ic_launcher"
        android:label="@string/app_name"
        android:theme="@style/AppTheme" >
        <activity
            android:name="com.example.app.MainActivity"
            android:label="@string/app_name" >
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
{% endhighlight %}


## build.gradle

As generated by Android Studio, but with otto dependency.

{% highlight groovy tabsize 2 %}
apply plugin: 'com.android.application'

android {
    compileSdkVersion 20
    buildToolsVersion "20.0.0"

    defaultConfig {
        applicationId "com.example.eventbus"
        minSdkVersion 15
        targetSdkVersion 20
        versionCode 1
        versionName "1.0"
    }
    buildTypes {
        release {
            runProguard false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}

dependencies {
    compile fileTree(dir: 'libs', include: ['*.jar'])
    compile 'com.squareup:otto:1.3.5'
}
{% endhighlight %}


## proguard-rules.pro

As generated by Android Studio, with otto excludes

{% highlight text tabsize 2 %}
-keepclassmembers class ** {
    @com.squareup.otto.Subscribe public *;
    @com.squareup.otto.Produce public *;
}
{% endhighlight %}


## References

* [Otto's documentation](http://square.github.io/otto/)


## Env

* AndroidStudio 0.8.1
* Tested on Android 4.4 emulator
