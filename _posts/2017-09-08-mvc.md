---
title: MVC
layout: post
tags: model view controller mvc mtnhut
---


## Problem

I want to create a rich web app and need a bit more than a [view]({% post_url 2017-09-02-view %}) layer.

MVC comes to mind with the following qualities:

* the "view" presents data
* the "bus" channels user input from the view to the controller
* the "controller" collects inputs as "state", calls the "model" with this state to fetch data and renders this data into the view
* the "router" maps input from the url to the controller
* the "app" encapsulates all the above

## Solution

[Choo](https://github.com/choojs/choo) provides a simple framework to accomplish this, with a few caveats:

* there's no controller (routes map directly to views), but there is a store/reducer
* the bus is global, not per-route; namespacing events helps reduce noise, eg `emitter.on('posts:like' ...`
* the line between "state" and "model" is blury; thinking of it purely as view state helps; extract complex data wrangling to a model layer
* there's no "route" event; shim by firing an initial event and listen for subsequent "navigation" events

## Example

{% highlight js linenos %}
const choo = require('choo')
const html = require('choo/html')
const get = require('lodash.get')
const set = require('lodash.set')
class Model {
  constructor(storage){
    this.storage = storage
  }
  async getPosts(userId){
    const posts = get(this.storage, `posts`)
    return Object.entries(posts).map(([id, post]) => {
      post.id = id
      post.likes = Object.keys(post.likes || {})
      return post
    })
  }
  async setLike(userId, postId){
    set(this.storage, `posts.${postId}.likes.${userId}`, true)
  }
}
function store(model, state, emitter){
  state.userId = '1'
  emitter.on('*', console.log)
  emitter.on('posts:load', () => {
    model.getPosts(state.userId).then(posts => {
      state.posts = posts
      emitter.emit('render')
    })
  })
  emitter.on('posts:like', postId => {
    model.setLike(state.userId, postId).then(() => {
      emitter.emit('posts:load')
    })
  })
}
function postsView(state, emit){
  function onLike(postId){
    return () => emit('posts:like', postId)
  }
  const posts = state.posts.map(post => {
    return html`
    <li>
      ${post.text}
      <span onclick=${onLike(post.id)}>üëç (${post.likes.length})</span>
    </li>
    `
  })
  return html`
  <body>
    <ul>
      ${posts}
    </ul>
  </body>
  `
}
var app = choo()
const storage = {
  posts: {
    1: {
      text: 'a',
      likes: {
        2: true
      }
    },
    2: {
      text: 'b'
    },
    3: {
      text: 'c'
    }
  }
}
const model = new Model(storage)
app.use(store.bind(store, model))
app.route('/', postsView)
app.mount('body')
app.emitter.emit('posts:load')
{% endhighlight %}

